@{
    Layout = null;
}

<!DOCTYPE html>

<html lang="es-pe">
<head>

    <meta name="viewport" content="width=device-width" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" />
    <link rel="stylesheet" href="~/technicals/css/interface-technical.css" />
    <title>Interfaz tecnica - HelpTechAppWeb</title>

</head>
<body>

    <div class="d-flex flex-column flex-lg-row h-lg-full bg-surface-secondary">

        <nav id="navbarVertical" class="navbar show navbar-vertical h-lg-screen navbar-expand-lg px-0 py-3 navbar-light bg-white border-bottom border-bottom-lg-0 border-end-lg">
            <div class="container-fluid">

                <a class="navbar-brand py-lg-2 mb-lg-5 px-lg-6 me-0"> <img src="https://www.svgrepo.com/show/60912/repair.svg" width="440"> </a>

                <div id="sidebarCollapse" class="collapse navbar-collapse">

                    <ul class="navbar-nav">

                        <li class="nav-item">
                            <a id="btnInterfaceTechnical" class="nav-link"> <i class="bi bi-house"></i> Pagina principal </a>
                        </li>

                        <li class="nav-item">
                            <a id="btnStatisticReport" class="nav-link"> <i class="bi bi-bar-chart"></i> Reporte estadistico </a>
                        </li>

                        <li class="nav-item">
                            <a id="btnReportReviews" class="nav-link"> <i class="bi bi-chat"></i> Reporte reseñas </a>
                        </li>

                    </ul>

                    <div class="nav-link text-xs font-semibold text-uppercase text-muted ls-wide">Consumidores</div>

                    <ul id="uChatsMembers" class="navbar-nav mb-md-4"> </ul>

                    <div class="mt-auto"></div>

                    <ul class="navbar-nav">

                        <li class="nav-item">
                            <a class="nav-link" data-toggle="modal" data-target="#mdlInformationTechnical"> <i class="bi bi-person-square"></i>Cuenta</a>
                        </li>

                        <li class="nav-item">
                            <a id="btnLogout" class="nav-link"> <i class="bi bi-box-arrow-left"></i>Cerrar sesion</a>
                        </li>

                    </ul>

                </div>

            </div>
        </nav>

        <div class="h-screen flex-grow-1 overflow-y-lg-auto">

            <header class="bg-surface-primary border-bottom pt-6">
                <div class="container-fluid">
                    <div class="mb-npx">
                        <div class="row align-items-center">
                            <div class="col-sm-6 col-12 mb-4 mb-sm-0">
                                <h1 class="h2 mb-0 ls-tight">Bienvenido </h1>
                            </div>

                            <div class="col-sm-6 col-12 text-sm-end">
                                <div class="mx-n1">
                                    <a id="btnJobsResponses" class="btn d-inline-flex btn-sm btn-neutral border-base mx-1" data-toggle="modal" data-target="#mdlJobsResponses">
                                        <span class=" pe-2"> <i class="bi bi-pencil"></i> </span>
                                        <span>Respuestas de trabajos</span>
                                    </a>
                                </div>
                            </div>

                        </div>

                        <hr />
                    </div>
                </div>
            </header>

            <main class="py-6 bg-surface-secondary">
                <div class="container-fluid">

                    <div class="row g-6 mb-6">

                        <div class="col-xl-3 col-sm-6 col-12">
                            <div class="card shadow border-0">
                                <div class="card-body">
                                    <div class="row">

                                        <div class="col">
                                            <span class="h6 font-semibold text-muted text-sm d-block mb-2">Ingreso</span>
                                            <span id="spnTotalIncome" class="h3 font-bold mb-0"></span>
                                        </div>
                                        <div class="col-auto">
                                            <div class="icon icon-shape bg-tertiary text-white text-lg rounded-circle"> <i class="bi bi-credit-card"></i> </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-sm-6 col-12">
                            <div class="card shadow border-0">
                                <div class="card-body">
                                    <div class="row">

                                        <div class="col">
                                            <span class="h6 font-semibold text-muted text-sm d-block mb-2">Consumidores atendidos</span>
                                            <span id="spnTotalConsumersServed" class="h3 font-bold mb-0"></span>
                                        </div>
                                        <div class="col-auto">
                                            <div class="icon icon-shape bg-primary text-white text-lg rounded-circle"> <i class="bi bi-people"></i> </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-sm-6 col-12">
                            <div class="card shadow border-0">
                                <div class="card-body">
                                    <div class="row">

                                        <div class="col">
                                            <span class="h6 font-semibold text-muted text-sm d-block mb-2">Tiempo de trabajo</span>
                                            <span id="spnTotalWorkTime" class="h3 font-bold mb-0"></span>
                                        </div>
                                        <div class="col-auto">
                                            <div class="icon icon-shape bg-info text-white text-lg rounded-circle"> <i class="bi bi-clock-history"></i> </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="col-xl-3 col-sm-6 col-12">
                            <div class="card shadow border-0">
                                <div class="card-body">
                                    <div class="row">

                                        <div class="col">
                                            <span class="h6 font-semibold text-muted text-sm d-block mb-2">Trabajos pendientes</span>
                                            <span id="spnTotalPendingsJobs" class="h3 font-bold mb-0"></span>
                                        </div>
                                        <div class="col-auto">
                                            <div class="icon icon-shape bg-warning text-white text-lg rounded-circle"> <i class="bi bi-minecart-loaded"></i> </div>
                                        </div>

                                    </div>
                                </div>
                            </div>
                        </div>

                    </div>

                    <div class="card shadow border-0 mb-7">

                        <div id="dvSearchJobs" class="card-header">

                            <h5 class="mb-0">Agenda de citas</h5>

                            <hr />

                            <span>Ingresar fecha:</span>
                            <input id="iptWorkDate" type="date" />

                            <span>Ingresar estado:</span>
                            <select id="sltJobsStates">
                                <option>PENDIENTE</option>
                                <option>EN PROCESO</option>
                            </select>

                            <a id="btnSearchJobs" class="btn btn-warning">Buscar</a>

                        </div>

                        <div class="table-responsive">

                            <table id="tblJobs" class="table table-hover table-nowrap"></table>

                        </div>

                        <div class="card-footer border-0 py-5"> <span id="spnTableMessage" class="text-muted text-sm"></span> </div>

                    </div>

                </div>
            </main>

        </div>

    </div>

    <div id="mdlInformationTechnical" class="modal fade" tabindex="-1" aria-labelledby="mdlInformationTechnical" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header float-right">

                    <h5>Detalles del perfil</h5>

                    <div class="text-right">
                        <i data-dismiss="modal" aria-label="Close" class="fa fa-close"></i>
                    </div>

                </div>

                <div class="modal-body">

                    <div>
                        <div id="dvInformationTechnical" class="box"></div>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-primary">Cambiar membresia</button>
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>
    <div id="mdlJobDetail" class="modal fade" tabindex="-1" aria-labelledby="mdlJobDetail" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header float-right">

                    <h5>Detalles del trabajo</h5>

                    <div class="text-right">
                        <i data-dismiss="modal" aria-label="Close" class="fa fa-close"></i>
                    </div>

                </div>

                <div class="modal-body">

                    <div>
                        <div class="box">

                            <p id="pAddress"></p>
                            <br>

                            <p id="pDescription"></p>
                            <br>

                        </div>
                    </div>

                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                </div>

            </div>
        </div>
    </div>
    <div id="mdlJobResponse" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="modalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">

                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal"><span aria-hidden="true">×</span><span class="sr-only">Close</span></button>
                    <h3 class="modal-title">Respuesta de atencion</h3>
                </div>

                <div class="modal-body">

                    <form id="frmJobDetail" class="modalForm">

                        <input id="iptId" type="hidden" />

                        <div class="form-group">
                            <label>Fecha de trabajo:</label>
                            <input id="iptWorkDate" type="datetime-local" class="form-control" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Tiempo estimado:</label>
                            <input id="iptTime" type="text" class="form-control" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Mano de obra:</label>
                            <input id="iptLaborBudget" type="text" class="form-control" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Prespuesto de materiales:</label>
                            <input id="iptMaterialBudget" type="text" class="form-control" autocomplete="off">
                        </div>
                        <div class="form-group">
                            <label>Estado de trabajo:</label>
                            <select id="sltJobState" class="form-control">
                                <option>PENDIENTE</option>
                                <option>DENEGADO</option>
                            </select>
                        </div>

                        <button type="submit" class="btn btn-default"><p>Registrar</p></button>
                    </form>
                </div>
            </div>
        </div>
    </div>

    <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.0.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script type="text/javascript">

        $(document).ready(function () {

            var specialties = [];
            var jobs = [];

            $(window).on('load', function () {

                loadSpecialties();
                loadJobsByTechnical();
                refreshInterfaceData();
                loadInformationTechnical();
            });

            $('#btInterfaceTechnical').on('click', function () {

                window.open('@Url.Action("InterfaceTechnical", "Technicals")', '_self');

                return false;
            });
            $('#frmJobDetail').on('submit', function () {

                var information = new FormData();

                information.append('Id', $('iptId').val());
                information.append('WorkDate', $('iptWorkDate').val());
                information.append('Time', $('iptTime').val());
                information.append('LaborBudget', $('iptLaborBudget').val());
                information.append('MaterialBudget', $('iptMaterialBudget').val());
                information.append('JobState', $('sltJobState').val());
                
                assignJobDetail(information);

                var index = jobs.findIndex(j => j.Id === id);

                jobs[index].WorkDate = $('iptWorkDate').val();
                jobs[index].Time = $('iptTime').val();
                jobs[index].LaborBudget = $('iptLaborBudget').val();
                jobs[index].MaterialBudget = $('iptMaterialBudget').val();
                jobs[index].AmountFinal = parseFloat($('iptLaborBudget').val()) + parseFloat($('iptMaterialBudget').val());
                jobs[index].JobState = $('sltJobState').val();

                fillTableJobs(jobs, "PENDIENTE");
            });
            $('btnStatisticReport').on('click', function () {

                window.open('@Url.Action("StatisticlReport", "Technicals")', '_self');

                return false;
            });
            $('btnReportReviews').on('click', function () {

                window.open('@Url.Action("ReportReviews", "Technicals")', '_self');

                return false;
            });
            $('#btnLogout').on('click', function () {

                window.open('@Url.Action("Logout","Access")', '_self');

                return false;
            });

            $('#dvSearchJobs').on('click', '#btnSearchJobs', function () {

                var filteredJobs = jobs.filter(j => j.WorkDate === $("#iptWorkDate").val() && j.JobState === $('sltJobsStates').val());

                fillTableJobs(filteredJobs);
            });
            $('#tblJobs').on('click', '#btnJobDetail', function () {

                var filteredJobs;

                $(this).parents("tr").find("#tId").each(function () {

                    filteredJobs = jobs.find(j => j.Id === $(this).html());
                });

                $('#pAddress').text(filteredJobs.Address);
                $('#pDescription').text(filteredJobs.Description);
            });
            $('#tblJobs').on('click', '#btnJobResponse', function () {

                $(this).parents("tr").find("#tId").each(function () {

                    $('#iptId').val($(this).html());
                });
            });
            $('#tblJobs').on('click', '#btnChat', function () {

                var chatRoomId;

                $(this).parents("tr").find("#tChatRoomId").each(function () {

                    chatRoomId = $(this).html();
                });

                window.open('@Url.Action("Messaging", "Communications")' + `?chatRoomId=${chatRoomId}`, '_blank');
            });
            $('#uChatsMembers').on('click', '#btnChat', function () {

                var chatRoomId;

                $(this).parents("li").find("#spnChatRoomId").each(function () {

                    chatRoomId = $(this).html();
                });

                window.open('@Url.Action("Messaging", "Communications")' + `?chatRoomId=${chatRoomId}`, '_blank');
            });

            function loadSpecialties() {

                jQuery.ajax({

                    url: '@Url.Action("AllSpecialties", "Specialties")',
                    method: 'GET',
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {

                        specialties = data;
                    },
                    error: function () {

                        //window.open('@Url.Action("Error", "Home")', '_self');
                    }
                });
            }
            function loadJobsByTechnical() {

                jQuery.ajax({

                    url: '@Url.Action("JobsByTechnical", "Attentions")',
                    method: 'GET',
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {

                        jobs = data;

                        fillTableJobs(jobs, 'PENDIENTE');
                    },
                    error: function () {

                        //window.open('@Url.Action("Error", "Home")', '_self');
                    }
                });
            }
            function refreshInterfaceData() {

                jQuery.ajax({

                    url: '@Url.Action("GeneralTechnicalStatistic", "Technicals")',
                    method: 'GET',
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {

                        for (const item of data) {

                            $('#spnTotalIncome').text(item.TotalIncome);
                            $('#spnTotalConsumersServed').text(item.TotalConsumersServed);
                            $('#spnTotalWorkTime').text(item.TotalWorkTime);
                            $('#spnTotalPendingsJobs').text(item.TotalPendingsJobs);
                        }
                    },
                    error: function() {

                        //window.open('@Url.Action("Error", "Home")', '_self');
                    }
                });
                jQuery.ajax({

                    url: '@Url.Action("ChatsMembersByTechnical", "Communications")',
                    method: 'GET',
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {

                        var contentHtml = '';

                        for (const item of data) {

                            contentHtml += `
                                <li>
                                    <a id="btnChat" class="nav-link d-flex align-items-center">
                                        <div class="me-4">
                                            <div class="position-relative d-inline-block text-white">
                                                <img alt="image" src="${item.ProfileUrl}" class="avatar rounded-circle">
                                                <span class="position-absolute bottom-2 end-2 transform translate-x-1/2 translate-y-1/2 border-2 border-solid border-current w-3 h-3 bg-success rounded-circle"></span>
                                            </div>
                                        </div>
                                        <div>
                                            <span id="spnChatRoomId" style="display:none;">${item.ChatRoomId}</span>
                                            <span class="d-block text-sm font-semibold">${item.Firstname}</span>
                                            <span class="d-block text-xs text-muted font-regular">${item.Lastname}</span>
                                        </div>
                                        <div class="ms-auto"> <i class="bi bi-chat"></i> </div>
                                    </a>
                                </li>`;
                        }

                        $('#uChatsMembers').html(contentHtml);
                    },
                    error: function() {

                        //window.open('@Url.Action("Error", "Home")', '_self');
                    }
                });
            }
            function loadInformationTechnical() {

                jQuery.ajax({

                    url: '@Url.Action("InformationTechnical", "Technicals")',
                    method: 'GET',
                    dataType: 'json',
                    contentType: 'application/json; charset=utf-8',
                    success: function (data) {

                        var filteredSpecialties = specialties.find(s => s.Id === data.SpecialtyId);

                        var contentHtml = `
                            <div class="img" style="text-align: center;"> <img alt="" src=${data.ProfileUrl}> </div>
                            <br>

                            <p>Membresia: ${data.Membership}</p>
                            <br>

                            <p>Especialidad: ${filteredSpecialties.Name}</p>
                            <br>

                            <p>Nombres: ${data.Firstname}</p>
                            <br>

                            <p>Apellidos: ${data.Lastname}</p>
                            <br>

                            <p>Edad: ${data.Age}</p>
                            <br>

                            <p>Email: ${data.Email}</p>
                            <br>

                            <p>Telefono: ${data.Phone}</p>
                            <br>`;

                        $('#dvInformationTechnical').html(contentHtml);
                    },
                    error: function () {

                        //window.open('@Url.Action("Error", "Home")', '_self');
                    }
                });
            }
            function assignJobDetail(information) {

                jQuery.ajax({

                    url: '@Url.Action("AssignJobDetail", "Attentions")',
                    method: 'POST',
                    data: information,
                    cache: false,
                    contentType: false,
                    processData: false,
                    success: function (data) {

                        if (data === true) {

                            $("#mdlJobResponse").modal("hide");

                            $("#mdlJobResponse").modal("hide").on('hidden.bs.modal', function () {
                                $('.modal-backdrop').remove();
                            });
                        }
                        else {

                            //window.open('@Url.Action("Error", "Home")', "_self");
                        }
                    },
                    error: function () {

                        //window.open('@Url.Action("Error", "Home")', "_self");
                    }
                });
            }
            function fillTableJobs(jobs, jobsStates) {

                if (jobs.length === 0) {
                    
                    $('#spnTableMessage').text('Usted no cuenta con citas pendientes.');
            
                    return;
                }
            
                var contentHtml = '';
            
                if (jobsStates === 'PENDIENTE') {

                    contentHtml = `
                        <thead class="thead-light">
                            <tr>
                                <th scope="col">Id</th>
                                <th scope="col">DNI</th>
                                <th scope="col">Nombre</th>
                                <th scope="col">Apellido</th>
                                <th scope="col">Contacto</th>
                                <th scope="col">Fecha</th>
                                <th scope="col">Tiempo</th>
                                <th scope="col">Mano de obra</th>
                                <th scope="col">Materiales</th>
                                <th scope="col">Monto final</th>
                                <th scope="col">Estado</th>
                                <th scope="col">Opciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbdJobs"></tbody>`;

                    $('#tblJobs').html(contentHtml);

                    contentHtml = '';

                    for (const item of jobs) {

                        var workDate = new Date(item.WorkDate);

                        contentHtml += `
                            <tr>
                                <td id="tId">${item.Id}</td>
                                <td id="tChatRoomId" style="display:none;">${item.ChatRoomId}</td>
                                <td id="tConsumerId">${item.ConsumerId}</td>
                                <td id="tFirstname">${item.Firstname}</td>
                                <td id="tLastname">${item.Lastname}</td>
                                <td id="tPhone">${item.Phone}</td>
                                <td id="tWorkDate">${getFormattedDate(workDate)}</td>
                                <td id="tTime">${item.Time}</td>
                                <td id="tLaborBudget">${item.LaborBudget}</td>
                                <td id="tMaterialBudget">${item.MaterialBudget}</td>
                                <td id="tAmountFinal">${item.AmountFinal}</td>
                                <td id="tJobState">${item.JobState}</td>
                                <td>
                                    <button id="btnDetailJob" class="btn btn-sm btn-neutral" data-toggle="modal" data-target="#mdlJobDetail">Detalle</button>
                                    <button id="btnChat" class="btn btn-sm btn-neutral">Mensaje</button>
                                </td>
                            </tr>`;
                    }
                }
                else if (jobsStates === 'EN PROCESO') {

                    contentHtml = `
                        <thead class="thead-light">
                            <tr>
                                <th scope="col">Id</th>
                                <th scope="col">DNI</th>
                                <th scope="col">Nombre</th>
                                <th scope="col">Apellido</th>
                                <th scope="col">Contacto</th>
                                <th scope="col">Estado</th>
                                <th scope="col">Opciones</th>
                            </tr>
                        </thead>
                        <tbody id="tbdJobs"></tbody>`;

                    $('#tblJobs').html(contentHtml);

                    contentHtml = '';

                    for (const item of jobs) {

                        var workDate = new Date(item.WorkDate);

                        contentHtml += `
                            <tr>
                                <td id="tId">${item.Id}</td>
                                <td id="tChatRoomId" style="display:none;">${item.ChatRoomId}</td>
                                <td id="tConsumerId">${item.ConsumerId}</td>
                                <td id="tFirstname">${item.Firstname}</td>
                                <td id="tLastname">${item.Lastname}</td>
                                <td id="tPhone">${item.Phone}</td>
                                <td id="tJobState">${item.JobState}</td>
                                <td>
                                    <button id="btnDetailJob" class="btn btn-sm btn-neutral" data-toggle="modal" data-target="#btnDetailJob">Detalle</button>
                                    <button id="btnJobResponse" class="btn btn-sm btn-neutral" data-toggle="modal" data-target="#mdlJobResponse">Respuesta</button>
                                    <button id="btnChat" class="btn btn-sm btn-neutral">Mensaje</button>
                                </td>
                            </tr>`;
                    }
                }

                $('#tbdJobs').html(contentHtml);
                $('#spnTableMessage').text(`Se está mostrando las citas ${jobsStates}.`);
            }

            function getFormattedDate(date) {
            
                let day = String(date.getDate()).padStart(2, '0');
                let mounth = String(date.getMonth() + 1).padStart(2, '0');
                let year = date.getFullYear();
                let hour = String(date.getHours()).padStart(2, '0');
                let minutes = String(date.getMinutes()).padStart(2, '0');
                let seconds = String(date.getSeconds()).padStart(2, '0');
            
                return `${day}/${mounth}/${year} ${hour}:${minutes}:${seconds}`;
            }
        });

    </script>

</body>
</html>